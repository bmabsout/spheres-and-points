{-# LANGUAGE OverloadedStrings #-}

module SphereDescent(main) where

import ThreeSharedDrawing
import Linear
import System.Random
import GHCJS.Three
import Control.Monad
import Data.IORef
import Data.Monoid
import Data.List.Split
import Numeric.AD
import qualified Data.Vector as V

import Spline
import Convenience
import GradientDescent


numIcos :: Num a => a
numIcos = 30

main :: IO ()
main = do
  -- polars <- randPolars
  -- let spline = polars 
  --              & makeSpline cost (conjugateGradientDescent cost) & traceIt V.length
  --              & reduceSpline 10
  -- print spline
  sceneSetup (SceneSetup {
      _spline     = cachedSpline
    , _createAll  = createAll
    , _updateAll  = updateAll
    , _divId      = "sphereDescent"
    , _width      = 200
    , _height     = 200
    , _zheight    = 20
  })

cost :: (Eq a,Floating a) => [a] -> a
cost l = l & v2sFromList
           &> sphericalToCartesian
           & gravityCost

v2sToList :: [V2 a] -> [a]
v2sToList l = l &> (\(V2 x y) -> [x,y]) & concat

v2sFromList :: [a] -> [V2 a]
v2sFromList l = l & chunksOf 2 &> (\[x,y] -> V2 x y)

createAll :: Scene -> [Double] -> Three [Mesh]
createAll scene startConfig =
  startConfig & v2sFromList
              &> (\polar ->
                    do ico <- makeIco scene
                       setSpherical polar 0 ico
                       return ico)
              & sequence

updateAll :: [Mesh] -> Double -> [Double] -> Three ()
updateAll elements time flatAngles = do
  -- print (currAngles & head &> (+ (V2 0 time)) &> sphericalToCartesian)
  let currAngles = v2sFromList flatAngles
  (zip elements currAngles) `forM_` (\(ico,currAngle) ->
        do angles <- rotation ico
           setRotation angles {eX = time, eY = time} ico
           setSpherical currAngle time ico
        )

setSpherical v time = setPosition (sphericalToCartesian v & rotator & v3ToVector3)
  where rotator v = rotate (axisAngle (V3 1 1 0) time) v

v3ToVector3 :: V3 Double -> Vector3
v3ToVector3 (V3 x y z) = Vector3 x y z

sphericalToCartesian :: Floating a => V2 a -> V3 a
sphericalToCartesian (V2 θ φ) =
    V3 (r * sin θ * cos φ)
       (r * sin θ * sin φ)
       (r * cos θ)
  where r = sqrt numIcos


randPolars :: (Random a,Floating a) => IO [a]
randPolars = do
    -- g <- newStdGen
    let g = mkStdGen 400
    return (randomRs (pure 0,pure 1) g 
            & take numIcos
            &> sphereAdjustment
            & v2sToList)
  where sphereAdjustment (V2 u v) = V2 (2*pi*u) (acos (2*v - 1))


cachedSpline = V.fromList [[2.206726002208016,1.4456800043791462,1.9311677750586025,0.5531503006856944,4.114959760737904,1.8896396474612225,1.9316883172692896,2.3991674278247666,0.8354583765377148,1.1699239191843995,2.974056457913802,1.3324630299851992,3.3045174572593927,1.6768784365524259,3.3064769262630898,1.7876169458461213,6.048645731029614,1.4410594689992169,4.58518976460473,1.2716851746330804,5.490224132928958,1.287988999801313,3.1323434551121,0.71836479118757,0.8475585809237208,2.0560911958821824,1.2154256296134751,1.1940252753780598,5.4080688041891385,2.6070692634245365,2.7071364941952853,1.3000786707539425,4.909554574759319,1.3734395206277752,4.805448544978431,2.1272877150159686,3.3773371581419003,1.3288094104058288,3.2003020004988008,0.18786907135217165,5.049407337141299,0.937189292826926,1.5979251742867457,1.6819290336761217,2.9633274731329537,1.1172708478609596,2.1037033064281965,2.0958968354855703,0.3037282785500222,1.3386037709038614,1.1062206802623598,1.0607566551083412,3.4992042457423294,1.798773547634684,1.7055085418041538,1.3017770036731375,6.2752843749063665,0.4002989769536641,4.438705700000521,0.8516386696080731],[2.206708140442632,1.4456734853478341,1.9311567342369813,0.5531363706054866,4.114987164255883,1.8896458720330438,1.9316328790194544,2.3992326208815222,0.8353226854001758,1.1699400479536204,2.9828371982307385,1.3392726784084987,3.3345170030724267,1.6166285165827268,3.3302714043679096,1.8484569028334903,6.048383147255477,1.4410604258471247,4.585136510254042,1.2716857757261362,5.490229189188701,1.2879917303618955,3.1231573502313212,0.7183353628794227,0.8475724252555417,2.056107451019974,1.215842294370987,1.1943842614893934,5.408057747831675,2.607073973128967,2.7067134762758616,1.3000819530609349,4.9095951762486125,1.3734798224729379,4.80544919713743,2.127297629801909,3.3820754183454627,1.3281655946238273,3.211697201735814,0.18785776759625666,5.049413711500343,0.9371484813715472,1.5979078802397666,1.6819731075574542,2.941050005891575,1.1104517144865367,2.1037189405278607,2.095866758740294,0.30382481491277125,1.3386034387310977,1.1059541060372828,1.0603490916710085,3.500649267506506,1.798869237245602,1.7055205284558754,1.3017425734102128,6.275339758106391,0.40029814349340087,4.4386942795147,0.851602456908197],[2.208254519399621,1.4462106256530858,1.9321015292758323,0.5543232167463382,4.112443134751853,1.8890918681969997,1.9363371175982653,2.393682881301222,0.8468447194722493,1.1685473546088416,2.8751180271615455,1.3146469172685924,3.5772041763586513,1.3967832303576184,3.329509197624603,1.7556198076229155,6.0705862238897605,1.440981467533924,4.589644184424601,1.271639173658936,5.489799041201817,1.2877601200075963,3.212734251146648,0.7216197908909557,0.8463896780920893,2.05472084908758,1.1816220877626864,1.164999655403785,5.408998832099801,2.606670699530013,2.750162563497539,1.2986442788587904,4.906130989695526,1.3700486719255942,4.805381663069376,2.1264482508111584,2.585829200148788,1.6506037142606083,2.9649296490709416,0.18828230481852476,5.048867089864275,0.9406308160580888,1.5993769485686706,1.678213049872927,3.295273797840702,1.1354742075908653,2.1023656448096455,2.098415386736759,0.29561342640026206,1.3386306378424226,1.1274751739736026,1.0938940461303888,3.2961604319581017,1.7869120425193645,1.7044912541547041,1.3046730185207305,6.270683192053843,0.40036722602909935,4.439642917396493,0.8547053974500741],[2.145631658757947,1.4297819068638542,1.9207272227413141,0.5398189852853096,4.13919264643115,1.8973244546139736,1.8769602689651803,2.4634745524896773,0.6873844375886865,1.1971781017400627,3.276053471344762,1.3712388301803262,3.846874835241963,1.4999695223394949,5.414628629441813,2.076989006366968,5.7300813510794955,1.443511233950913,4.53426307721043,1.2716684079764833,5.494875422036756,1.2907824652397366,3.5264893623546545,0.43960001394224707,0.8595177286991901,2.070474950279256,1.6912938479826467,1.6327315026275238,5.3980420055624885,2.6113681067693975,2.0956146166952823,1.2559813697588968,4.949071095036225,1.411076949751947,4.80570359149387,2.1361688459972465,3.1160464586891563,1.4370060114939638,2.6048889774030264,0.18517149212440814,5.05500438260782,0.9001340206440164,1.5725950255153438,1.7298175513590903,5.382695399916639,0.9173003847257838,2.1077112122761403,2.071635703530444,0.39807916803391047,1.338156807892692,0.7973909758987471,0.5594204040156133,3.8651893004394813,2.0606549530717344,1.7144284560436975,1.2678130147673385,6.35461405171633,0.3984673374922872,4.428615948990801,0.819003017424567],[2.425792579013881,1.5830681844816454,1.8121393372998182,0.3982572302145616,4.448854463750437,1.923628245986046,1.7573195727840212,2.6414170144742104,1.004609733225664,1.201218565200928,3.4458077849836,1.387272070621401,4.042311879146094,1.4094631711292958,5.5094290131931265,2.1646321795565604,5.870408388852397,1.5092071847555966,4.4778646461742735,1.2223854676718455,5.327227026857887,1.2684226288298959,3.8327800284588784,0.31496230650744556,0.879282472792327,2.167026193105027,1.7620119486606045,1.6621831180156463,5.200990974728518,2.731758979700665,2.0687119662393485,0.9193001132850562,4.754917126067834,1.6070526429956775,4.816188818380059,2.2414980554794957,2.882808408496327,1.4102072842146491,2.43112999592128,0.1614086475911669,4.958404742862954,0.6992601327900378,1.3463305241644778,1.9728305970873148,5.552568723943237,0.6057298081821532,2.1193662767875336,2.181937568332502,0.539258702895013,1.3868474661873786,0.9323838696291471,0.4173438378842731,3.887322304109924,2.326365738467765,1.4213090999250886,1.137596477943726,6.257874277672429,0.3899412415453033,4.403768630371754,0.6314997410309452],[2.2385112960175517,1.632661380026653,1.6846737469495785,0.2263718571213691,4.359342203579767,1.9863076669306143,1.491833626825065,2.8986386082473095,1.1327435546380258,1.296944408764194,3.499817611413418,1.370775815696625,4.130854569728707,1.348566147240974,5.360039075271354,2.2933570739607223,5.693090596246213,1.5150802769669527,4.546837566730741,0.9564258200048499,5.116960280510706,1.0705763341219765,3.8506596287070805,2.036888296270741e-2,0.8601618078907007,2.5427441653684593,1.6463608486868595,1.6391806169082583,5.035774669202441,2.9810472906776475,2.161637202770439,0.8192866504029559,4.855251657929695,1.6889268102446162,4.695619760541878,2.5088218062756864,2.8637453045573356,1.4116244115495904,2.242689261127995,0.130968772722744,4.993671616513615,0.35771728973650146,1.4212488141556492,2.2212853324124726,5.559606752462542,0.16576999061562517,2.0432245146901704,2.4836550798384303,0.6069808315775571,1.4487865371205921,0.8995167939405271,0.4498747779191197,3.965721267645376,2.578361041559278,1.5663214708538027,0.8724244462343689,6.358860303401915,0.37429780404790647,4.386558810412392,0.29246559440985254],[2.299892539785819,1.8188922597516481,1.6244183004411235,0.1722713874873647,4.457789074243594,1.9529976852254396,1.5243609705432537,2.8992186966718183,1.204010067551174,1.292902291739236,3.573220662656796,1.380809218847564,4.219555302179062,1.3135014389404642,5.297855408034292,2.282368355346185,5.662432844953358,1.51832886805471,4.520521695424941,0.7906235172518141,5.079344817675696,1.0363966088132663,3.7773613485251625,-8.317241055315864e-3,0.9084492406114831,2.4735491520833963,1.6879679919285895,1.6310386285805205,5.168809784383365,2.9651688954382456,2.0942193988970326,1.000358385821725,4.950318715673842,1.6576589905663457,4.623135126071405,2.5990216861878195,2.871977199613792,1.3867714836798688,2.2188350648250705,0.15280577183043426,5.015937093363855,0.3110762397728063,1.4639850584923002,2.21113299686722,5.637118754804759,0.25878464126097056,2.04084046557554,2.5085902580821746,0.6800762949284006,1.6635292430902722,0.8804137636307819,0.5221578636817712,3.924147171127516,2.4277453977794226,1.534909075089959,0.7841587909893715,6.452174183332049,0.33346241396327503,4.325914510593585,0.22949664147144708],[2.3211924927635383,1.9124974405682234,1.638446618657009,9.365696348416017e-2,4.517361730448181,2.0399278887060284,1.4785914714774886,2.8529122005549166,1.2111861263441135,1.2797653487348117,3.6889338344237443,1.3758085077663684,4.331011119720558,1.3571808905638314,5.1795402377574975,2.2317002850513625,5.709094128050503,1.5399290012654043,4.474553549002954,0.7131316219774126,5.054446598853249,0.9881562505105349,3.7692453112872903,5.717073627494708e-2,0.9371557439534303,2.5827939050828683,1.7306343689752233,1.5864247537745662,5.27136175324534,2.94056577269846,2.1089882605282635,1.0441252325011086,4.96033914644604,1.6018584594248104,4.561181844105624,2.6610422629197132,2.9479518760291468,1.2911029118580128,2.321506168147447,0.2145286441935779,5.033062818923033,0.29797907338543517,1.463211276913616,2.120139177700085,5.6960136089438445,0.3325915328688035,1.9963867830390136,2.549953639879752,0.7218078035900842,1.8039551610953275,0.9120184395441757,0.5997365415329604,3.928441839800965,2.376695097754159,1.562449179275736,0.681952468320119,6.540622693505826,0.28009818555553434,4.362176411406512,0.1334744794306134],[2.3112621863130265,1.89245213925531,1.6048470420843657,0.14454728189690427,4.479550674797958,2.034436599521123,1.4717512777116317,2.800705936387587,1.2207059258542803,1.2807422040628544,3.782062139253637,1.307676021316057,4.428964742591435,1.383169400021542,5.1416303444279,2.283306282083698,5.593268270569797,1.6430107599578254,4.337450145110437,0.7257644804778662,5.094128315016737,0.9134399301586391,3.7831110913857433,0.12999446693227928,0.8721666562441515,2.6768422459568337,1.7664805256861296,1.5444631221491512,5.304368680360406,2.975622801363972,2.191483224345326,0.9946413631253259,4.991738346489327,1.5665734761643528,4.606051229886319,2.683060502466999,2.978094373515977,1.196691335862386,2.2829689725728133,0.21245744655415214,4.9882508956657965,0.3151868314923477,1.3711323576031793,2.0817650301779027,5.7914466150364605,0.32816795511000063,1.9896552051640262,2.501758574694305,0.6881104629714294,1.7498730348099008,0.968092592730766,0.612745526029361,3.9039474857082084,2.449984652904158,1.6183442010689006,0.7584221889513836,6.533459985358151,0.24541469089911208,4.418238006323179,9.853225283091041e-2],[2.3960007713478015,1.8759180471178654,1.5235851363617847,0.23427525541997288,4.382099124501617,2.0446353422979633,1.457600848240953,2.6823060878938914,1.2036084107769307,1.3631023638318407,3.824247297087865,1.2889768097969125,4.501882242657517,1.3586017369909387,5.057020986760726,2.326018111523338,5.6365098338942135,1.8223490326860468,4.331792693150938,0.7049006902216963,5.0953240799701724,0.8792795760137235,3.8089547932540366,0.13128579512591532,0.8315784852812493,2.733969990292916,1.7886277293496242,1.5747635818832904,5.334103224397805,3.024506320929846,2.35244532065012,0.9940691218942431,5.028511479777473,1.5972311000802994,4.601773079314137,2.7169733071019824,3.0867113969341817,1.0551141089757867,2.1113233256094848,8.921698643477571e-2,4.957066101894453,0.2333242307009901,1.2869695511532835,2.072419194832981,5.846048725638569,0.39313343202596696,1.9775355653676694,2.3975560501157256,0.6447317525633383,1.6454030315522727,1.0157211140136153,0.6143265859038609,3.833271435775246,2.5313161605031755,1.6712156948455956,0.89643481419417,6.562090020352717,0.18047276166647508,4.419970567998122,5.8787413610687705e-2],[2.465486504492139,1.9008043135605481,1.4994508030405453,0.2999802463012182,4.349946162627585,2.0378558420467794,1.4607896984930897,2.665028118601839,1.2268926374549753,1.3928175793518183,3.870956198701611,1.3158215701699731,4.532361798137402,1.3172994731927357,4.998746222444915,2.3056386925546186,5.658035210419368,1.9227871896579494,4.437866597630904,0.6863966816979754,5.103797956851396,0.868679960560086,3.8443390507222084,8.406955061518939e-2,0.8558497200862022,2.7627565516444497,1.8086813426210449,1.6376984746570435,5.317671417112588,2.9797272518733435,2.3963743494545957,0.9164502471375884,5.046893766722682,1.6351538571396753,4.582294070402561,2.7264068430257433,3.1460391039740925,0.962098714726434,2.044612634606931,8.419545539923377e-2,4.987079795927592,0.2080445364796937,1.2769025828499048,2.0479618787194953,5.790580415415842,0.47830756508745526,1.9666932349415343,2.355831580690139,0.5939564414657499,1.6029627575767278,1.0379509726291705,0.6918862848903269,3.8035086559698525,2.5557683241081417,1.7455715650643633,0.9451587212690551,6.607601703529903,0.13886346758719553,4.402085451792862,-2.9451764924689483e-2]]