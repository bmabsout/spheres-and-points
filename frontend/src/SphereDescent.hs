{-# LANGUAGE OverloadedStrings #-}
{-# LANGUAGE DataKinds #-}
{-# LANGUAGE TypeInType #-}
{-# LANGUAGE FlexibleContexts #-}
{-# LANGUAGE NegativeLiterals #-}

module SphereDescent(main) where

import ThreeSharedDrawing
import Linear
import ConstructibleV
import System.Random
import GHCJS.Three
import Control.Monad
import Data.IORef
import Data.Monoid
import Numeric.AD
import qualified Data.Vector as V

import Spline
import Convenience
import GradientDescent


numIcos :: Num a => a
numIcos = 30

main :: IO ()
main = do
  polars <- randPolars
  let spline = polars 
               & convergedSpline sphericalToCartesian
               & reduceSpline 10
  sceneSetup (SceneSetup {
      _spline     = cachedSpline
    , _createAll  = createAll
    , _updateAll  = updateAll
    , _divId      = "sphereDescent"
    , _width      = 200
    , _height     = 200
    , _zheight    = 20
  })

createAll :: Scene -> [V 2 Double] -> Three [Mesh]
createAll scene startConfig =
  startConfig &> (\polar ->
                    do ico <- makeIco scene
                       setSpherical polar 0 ico
                       return ico)
              & sequence

updateAll :: [Mesh] -> Double -> [V 2 Double] -> Three ()
updateAll elements time currAngles = do
  (zip elements currAngles) `forM_` (\(ico,currAngle) ->
        do angles <- rotation ico
           setRotation angles {eX = time, eY = time} ico
           setSpherical currAngle time ico
        )

v3ToVector3 :: V3 Double -> Vector3
v3ToVector3 (V3 x y z) = Vector3 x y z


setSpherical v time = setPosition (sphericalToCartesian v & rotator & v3ToVector3)
  where rotator = fromV &. rotate (axisAngle (V3 1 1 0) time)

sphericalToCartesian :: Floating a => V 2 a -> V 3 a
sphericalToCartesian (θ :> φ :> Nil) =
    vec (r * sin θ * cos φ)
        (r * sin θ * sin φ)
        (r * cos θ)
  where r = sqrt numIcos


randPolars :: (Random a,Floating a) => IO [V 2 a]
randPolars = randVecs &> take numIcos &> map sphereAdjustment
  where sphereAdjustment (u :> v :> Nil) = vec (2*pi*u) (acos (2*v - 1))


cachedSpline :: V.Vector [V 2 Double]
cachedSpline = V.fromList [[V2 2.2067254426936183 1.4456798002237348,V2 1.931167429234123 0.5531498643512209,V2 4.1149606196218835 1.8896398425503746,V2 1.9316865808385746 2.3991694698395047,V2 0.8354541264258055 1.1699244244424865,V2 2.9743498898295377 1.3326714660926458,V2 3.3084316525429505 1.675199193485517,V2 3.3040841501920752 1.78931513289135,V2 6.048637506694668 1.4410594989624124,V2 4.585188096621624 1.2716851934555704,V2 5.490224291303729 1.287989085328281,V2 3.132060792986064 0.7183638687604226,V2 0.8475590145778795 2.056091705044487,V2 1.2154386765410612 1.1940365158937316,V2 5.408068457872186 2.6070694109527697,V2 2.7071232320617096 1.3000787756246568,V2 4.90955584653049 1.3734407829939863,V2 4.805448565434643 2.1272880255938094,V2 3.377487656912035 1.3287887452076477,V2 3.200653321010344 0.1878687284684608,V2 5.049407536818141 0.9371880144799615,V2 1.5979246326026053 1.68193041420978,V2 2.9626192348825966 1.117062114954727,V2 2.103703796197139 2.0958958934310723,V2 0.30373130230411605 1.338603760502482,V2 1.1062123343176729 1.060743892938607,V2 3.4992496500515293 1.7987765685898305,V2 1.7055089172916111 1.3017759252238712,V2 6.275286109468597 0.4002989508535468,V2 4.438705342371845 0.8516375352714313],[V2 2.2067256944750975 1.44567989209367,V2 1.9311675848551388 0.553150060701734,V2 4.114960233124092 1.8896397547602561,V2 1.9316873622323962 2.399168550932872,V2 0.8354560389761647 1.1699241970763474,V2 2.9742178454674564 1.3325776698442948,V2 3.3066702646653496 1.675954852865626,V2 3.305160899424032 1.788550948720997,V2 6.048641207645394 1.4410594854789744,V2 4.585188847214022 1.2716851849854498,V2 5.490224220035082 1.2879890468411452,V2 3.1321879909427803 0.718364283852639,V2 0.8475588194335082 2.05609147592145,V2 1.2154328054236474 1.1940314576616793,V2 5.408068613714814 2.6070693445650646,V2 2.707129200021819 1.3000787284328355,V2 4.909555274233464 1.3734402149291913,V2 4.805448556229348 2.127287885833781,V2 3.3774199324654743 1.3287980445468293,V2 3.2004952267801494 0.18786888276613067,V2 5.049407446963562 0.9371885897360955,V2 1.5979248763604685 1.6819297929696337,V2 2.962937942095257 1.1171560447625317,V2 2.103703575801115 2.0958963173555967,V2 0.30372994161477385 1.3386037651831026,V2 1.106216089992782 1.0607496359149873,V2 3.499229218112389 1.7987752091600147,V2 1.7055087483222553 1.301776410526041,V2 6.275285328915594 0.4002989625985996,V2 4.4387055033047496 0.85163804572292],[V2 2.206694247958444 1.445668414990147,V2 1.931148146931276 0.5531255360986583,V2 4.115008478103201 1.8896507133666822,V2 1.9315897603806935 2.3992833265923323,V2 0.8352171478487568 1.1699525925519034,V2 2.9896666629216884 1.3445690716266205,V2 3.357849983149231 1.5697674677174054,V2 3.348778220671658 1.8957768693792216,V2 6.048178915431149 1.441061170062164,V2 4.585095090203508 1.2716862432429572,V2 5.490233121835168 1.2879938541312377,V2 3.116012601990715 0.7183124741953081,V2 0.8475831930691801 2.0561200939049233,V2 1.216166366960163 1.1946634729093193,V2 5.408049148442538 2.607077636232413,V2 2.706384462338532 1.3000845059663733,V2 4.909626755184729 1.373511168352509,V2 4.805449704372207 2.1273053413020846,V2 3.3857607318371223 1.327664849015604,V2 3.220560136031268 0.1878489757861006,V2 5.049418669335155 0.9371167391284749,V2 1.5978944293143384 1.682007387242935,V2 2.923723086926059 1.1051479440842078,V2 2.1037311003831554 2.0958433657161906,V2 0.3038998987504649 1.3386031803745038,V2 1.10574677052889 1.0600320978864164,V2 3.501773173323088 1.7989436624985387,V2 1.7055298514072144 1.301715794316827,V2 6.2753828339286315 0.40029749524652947,V2 4.438685396914618 0.8515742914749601],[V2 2.204351564423001 1.4445724805408777,V2 1.9315256565146164 0.5535841408565279,V2 4.1137210541063185 1.8895339278288963,V2 1.9332587320994679 2.3972970305698023,V2 0.8384289139077022 1.1699347510672595,V2 2.9229825276689465 1.3155268829663331,V2 3.6083746509381096 1.391409573973581,V2 3.4848446708246144 1.7605748490580708,V2 6.052157722089564 1.4411090359029297,V2 4.586789947551532 1.2716341209034105,V2 5.490134325417556 1.287907956076725,V2 3.242855658381744 0.7056080289335159,V2 0.8470480936396086 2.0555177080539218,V2 1.2492658807601478 1.2343876467248491,V2 5.408449883916891 2.606893401619913,V2 2.681681928685393 1.2964784689363202,V2 4.90836133233186 1.3721481605011439,V2 4.8054008324375825 2.126937919045895,V2 2.5551543362801334 1.6637415909305595,V2 2.924845373263161 0.1881128321212508,V2 5.0492307414889295 0.9385766237059483,V2 1.5983883772182301 1.6804994436717082,V2 3.4412578350221343 1.125665164728018,V2 2.1024549399100265 2.0971394131374845,V2 0.30096274007696694 1.3385948729684496,V2 1.069979214260533 1.0215009614387682,V2 3.2714858574609553 1.801913708069157,V2 1.704988287260311 1.3028006178417288,V2 6.275317175594819 0.40025905594077027,V2 4.4390845352839 0.8528984866424845],[V2 2.3716111018847745 1.5837725203986417,V2 1.88341998336137 0.48628942440783185,V2 4.376344940269016 1.8791495639449993,V2 1.8214943971858242 2.5460058921412143,V2 0.898971523756016 1.1992659569019997,V2 3.5029445181558554 1.3827293447500888,V2 3.988153050348779 1.4516421581912815,V2 5.602513230996656 2.143916715456319,V2 5.917702652592432 1.4992322886947695,V2 4.49619137481981 1.2702173587719492,V2 5.232137619694502 1.312124615407516,V2 3.6967888715649284 0.3647502164637326,V2 0.8805587219793427 2.1076449912002664,V2 1.8004501824146892 1.6368798690668946,V2 5.311213242457985 2.665157109379183,V2 2.053362306490575 0.9694337513542519,V2 4.908186737971261 1.4810065411222926,V2 4.80120739958435 2.1692903270392003,V2 2.8699104440174334 1.4093586199476615,V2 2.5039952439057096 0.1772494326374805,V2 5.001432189924286 0.8153558765172593,V2 1.3624970309124986 1.9201636655506942,V2 5.613579479830265 0.7212835296993594,V2 2.122076785103465 2.118900548639699,V2 0.3757360828767886 1.3684536330834227,V2 0.8468336591746649 0.46184837072678525,V2 3.8565603267864503 2.2330376887186922,V2 1.49706692624661 1.19720756010352,V2 6.299778711878204 0.39379462114493924,V2 4.414632879145135 0.73658013129955],[V2 2.299807040862187 1.5975050066734062,V2 1.6751762188039736 0.21148937967782347,V2 4.387733967657876 2.030887789176683,V2 1.540402456123594 2.88034361730426,V2 1.1111059111092179 1.2376960661487582,V2 3.4743413603535203 1.3779557843007124,V2 4.092426209336615 1.3574443914447447,V2 5.363381727091741 2.2551127201743277,V2 5.747055765411323 1.5351494773153265,V2 4.552417181591497 1.013202033509395,V2 5.104236424316221 1.1346718484846319,V2 3.91116206477996 9.204048400564425e-2,V2 0.8418523583957088 2.4696406157636233,V2 1.699140835740295 1.6408267277506101,V2 5.010407262605215 2.9781973699990236,V2 2.1118658665629195 0.8362560051440151,V2 4.819534845348289 1.678198736489533,V2 4.739830822959108 2.4611602157883814,V2 2.8756776311567527 1.4107731936713113,V2 2.2555852488894397 0.12748765211537771,V2 4.948791895911771 0.40756179650525404,V2 1.4035099724662636 2.170090865654644,V2 5.491547709827018 0.24407053382149557,V2 2.0663083225167576 2.4174057518990413,V2 0.547208400617652 1.4302392535548338,V2 0.9804623627246105 0.3944028772606138,V2 3.9756168492818693 2.5474304179615412,V2 1.5660673634486661 0.9346788056837535,V2 6.340480933270282 0.3773707064659781,V2 4.448335745213281 0.34913434905103435],[V2 2.249243022838821 1.7691965256720208,V2 1.6178112817388342 0.20129693671320192,V2 4.426098711786213 1.9454795001428633,V2 1.522983648200453 2.9069974547142574,V2 1.2020857387406152 1.3073956386389989,V2 3.5451565954034012 1.3728536205632922,V2 4.200701782590092 1.3047656897407542,V2 5.317085537581106 2.3138560542275073,V2 5.6449911074109105 1.5080030386242997,V2 4.529561460070235 0.8294690613597703,V2 5.098330750797383 1.0238389882154568,V2 3.7878622896685537 -2.005278703286316e-2,V2 0.9162710398832857 2.478495678324824,V2 1.6659804040722639 1.659107436333506,V2 5.1420610053344324 2.974449320475447,V2 2.124198944252134 0.9589358029704125,V2 4.926993331996184 1.6810403280210988,V2 4.643295933919306 2.566697738911609,V2 2.85322557381922 1.4048144849871247,V2 2.213998471134989 0.14002161672824007,V2 4.988545689752563 0.33628972089836356,V2 1.4589556572584708 2.2122347207962685,V2 5.650537419047832 0.22411969442482038,V2 2.0431763467000805 2.501672536010404,V2 0.6629825327145935 1.5891528328906273,V2 0.8690586237286761 0.49840248533416714,V2 3.9444392530457617 2.469673996789677,V2 1.5297390918267897 0.8156785048576337,V2 6.421518326107012 0.35018074334581073,V2 4.329730807896661 0.24714967097932122],[V2 2.324121440418247 1.9098696644823847,V2 1.6376895843567463 9.543079342177894e-2,V2 4.514559054518374 2.0342899734430637,V2 1.4858135208847532 2.856544106889319,V2 1.2086192887150973 1.2800473903161507,V2 3.676950019355753 1.3807017212939168,V2 4.315479521041523 1.355187033351097,V2 5.1894786076408 2.228922159586611,V2 5.712826374946813 1.5353873286376536,V2 4.483468463116557 0.7100268784567825,V2 5.05349822624819 0.9997182359245054,V2 3.76728723582979 4.957959701966408e-2,V2 0.9325389604471531 2.5662258575573964,V2 1.7312663352052058 1.5876118826131693,V2 5.264099578302417 2.941787135731289,V2 2.102246733795429 1.0505454986818277,V2 4.964645395129708 1.6069093456649342,V2 4.561140753242582 2.658606744008025,V2 2.9465165131020217 1.300667040230485,V2 2.315427890257568 0.2071816164945398,V2 5.035204450885935 0.29335631968452036,V2 1.4668047738852825 2.1332004590824405,V2 5.685931212102151 0.33001398395287795,V2 1.9979175809148082 2.5483281374201745,V2 0.7215717458811801 1.8027762216970737,V2 0.9079040853250836 0.5941775824449519,V2 3.9247756576862796 2.3740785181666215,V2 1.5556912348183471 0.6836576544686309,V2 6.536473538001674 0.28405367974178675,V2 4.357442237896113 0.14506886370119318],[V2 2.3079950761935306 1.8969781300479314,V2 1.61430866599833 0.13425394688396558,V2 4.490528555679253 2.036527557839879,V2 1.4704790880004985 2.8138569263929876,V2 1.223356216567981 1.2760709999791997,V2 3.773436824927137 1.3161925844090092,V2 4.419248032175059 1.3798381635413626,V2 5.147266768974141 2.2765434141485055,V2 5.604535623142016 1.6226262748697606,V2 4.354378805740198 0.7290630017211985,V2 5.0906566631274615 0.918374873983194,V2 3.781415574370243 0.12201556411509477,V2 0.8868256285716143 2.6688326890589824,V2 1.758261933928818 1.548327072805267,V2 5.30055764377045 2.965609331175666,V2 2.174881179681306 0.994277802826209,V2 4.981438335941358 1.566656208826461,V2 4.600388778552233 2.6789870203562414,V2 2.966852525340496 1.212403307082521,V2 2.2972913663319656 0.22450935843011094,V2 4.997532584792776 0.3222603748722733,V2 1.3870312160972853 2.0808898223011907,V2 5.777485011708545 0.3267745890833007,V2 1.9908736555858808 2.5146487273753637,V2 0.6934944055293425 1.7617933965818073,V2 0.9608429093444384 0.6149906670316062,V2 3.9131368788251133 2.4367932896048368,V2 1.613845024517111 0.741891456609808,V2 6.534991126513515 0.25178646085946393,V2 4.412167776185569 9.738903645032632e-2],[V2 2.3837857616435985 1.8752954696668638,V2 1.530841973190445 0.2240293983295638,V2 4.391444822294163 2.0428566799707477,V2 1.4593262953098494 2.692189593748828,V2 1.2030189866441288 1.3537242534260474,V2 3.81964322031755 1.286956635272255,V2 4.4949684411326745 1.3649073763379753,V2 5.067826024780047 2.3238833172178643,V2 5.626840038105707 1.8032686595016245,V2 4.321610577180366 0.7060072898571677,V2 5.095854627727212 0.8831222396013265,V2 3.804768350463645 0.1361475594118689,V2 0.8297832582974507 2.7279241698497567,V2 1.7883919321548065 1.5673789482572853,V2 5.331885208148835 3.02485760944177,V2 2.336776715071922 0.9984500971519172,V2 5.026720669013445 1.5922422488200956,V2 4.605481794114036 2.7133073957391636,V2 3.075898595892016 1.0707528594722893,V2 2.130922324880231 9.938276963371216e-2,V2 4.954999980351181 0.2408671661979314,V2 1.2916639711252444 2.075600471345503,V2 5.846988221369362 0.38243588130422046,V2 1.979334688538651 2.4069932185127927,V2 0.6509457562214871 1.655638336551825,V2 1.0107495198976106 0.6093482554478693,V2 3.840131930172853 2.5254811483882103,V2 1.6624767677487415 0.8832782613240511,V2 6.555833292269395 0.1879402185530924,V2 4.4232509842504975 6.919649420367886e-2],[V2 2.4608919069375323 1.8973598040801383,V2 1.5001384028806979 0.2947196163705859,V2 4.350297311884674 2.0403335153555906,V2 1.4594547029200433 2.6631700221682086,V2 1.2238265756588345 1.3933515634526117,V2 3.8655073035321483 1.3133886665355097,V2 4.530600618799865 1.3197764694411027,V2 5.0025729379304 2.309914838958505,V2 5.6605446037693925 1.9163517215151935,V2 4.428074976042534 0.6902149162575308,V2 5.101582080170347 0.867577204262935,V2 3.8411005690683244 8.810375039201034e-2,V2 0.8546200203216311 2.761847587201431,V2 1.8046456082533255 1.6320151090200405,V2 5.322602346114042 2.985806175749602,V2 2.397183957059357 0.9266940466720467,V2 5.0450146686207145 1.6322575573895066,V2 4.582729510713937 2.7271319931396203,V2 3.141099020161107 0.9694741798317716,V2 2.0440659725208334 7.94920693545016e-2,V2 4.984938010224621 0.2083206582710458,V2 1.2773285237206313 2.0493837432513993,V2 5.798028830675617 0.4697843109218678,V2 1.9672961859386842 2.3581666585265815,V2 0.5982665368373676 1.6043708043131866,V2 1.0373893138552535 0.6824232409888042,V2 3.8041570901771657 2.5541932729507106,V2 1.7385746212826878 0.9437888665436226,V2 6.603910596179182 0.14173359255733167,V2 4.401882813463854 -2.2200310452873382e-2]] &> (map toV)